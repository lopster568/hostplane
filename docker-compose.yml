services:
  # ── Control Plane API + Worker ────────────────────────────────────────────
  control-plane:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "127.0.0.1:${API_PORT:-8080}:${API_PORT:-8080}"
    environment:
      API_PORT: ${API_PORT:-8080}
      API_KEY: ${API_KEY}
      CONTROL_DSN: control:${DB_PASSWORD}@tcp(mysql:3306)/controlplane
      WP_DSN: control:${DB_PASSWORD}@tcp(mysql:3306)/
      DOCKER_HOST: ${DOCKER_HOST:-tcp://10.10.0.10:2376}
      DOCKER_CERT_DIR: /certs
      CADDY_CONTAINER: ${CADDY_CONTAINER:-caddy}
      CADDY_CONF_DIR: ${CADDY_CONF_DIR:-/etc/caddy/sites}
      CADDY_STATIC_VOLUME: ${CADDY_STATIC_VOLUME:-caddy_static_sites}
      BASE_DOMAIN: ${BASE_DOMAIN}
      APP_SERVER_IP: ${APP_SERVER_IP:-10.10.0.10}
      DOCKER_NETWORK: ${DOCKER_NETWORK:-wp_backend}
      CLOUDFLARED_CONFIG: /cloudflared/config.yml
      TUNNEL_NAME: ${TUNNEL_NAME}
      TUNNEL_SERVICE_TARGET: ${TUNNEL_SERVICE_TARGET}
    volumes:
      # TLS certs used to authenticate to the Docker daemon on app-01
      - ${DOCKER_CERT_DIR:-./certs}:/certs:ro
      # cloudflared config.yml — control plane reads and writes this file
      - ${CLOUDFLARED_CONFIG_DIR:-./cloudflared}:/cloudflared
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - internal

  # ── MariaDB ───────────────────────────────────────────────────────────────
  mysql:
    image: mariadb:11
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: controlplane
      MARIADB_USER: control
      MARIADB_PASSWORD: ${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      # Optional: drop any extra .sql init scripts in ./initdb/
      - ${INITDB_DIR:-./initdb}:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - internal

volumes:
  mysql_data:

networks:
  internal:
    driver: bridge
